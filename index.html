

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title id="page-title">Interactive Globe ‚Äì Intercultural Communication 3D</title>

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --page-bg: #fff2e6; /* ~10% of #FF7900 */
      --accent: #ff7900;
      --text-main: #444444;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Roboto", system-ui, sans-serif;
      color: var(--text-main);
      font-size: 16px;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;

      /* subtle diagonal infographic-style pattern */
      background-color: var(--page-bg);
      background-image: repeating-linear-gradient(
        -45deg,
        rgba(255, 121, 0, 0.06) 0,
        rgba(255, 121, 0, 0.06) 4px,
        rgba(255, 255, 255, 0.03) 4px,
        rgba(255, 255, 255, 0.03) 8px
      );
      min-height: 100vh;
      height: 100%;
    }

    /* LANGUAGE SWITCH STYLES (Vertical, hidden by default) */
    #language-switch {
      position: absolute;
      top: 24px;
      right: 2vw;
      z-index: 10;
      display: flex;
      flex-direction: column; 
      gap: 4px;
      background: none; 
      padding: 0;
      border-radius: 0;
      backdrop-filter: none;
      box-shadow: none;
    }

    /* Style for the Globe Toggle Button */
    #lang-toggle-btn {
      border: none;
      cursor: pointer;
      transition: background 0.15s ease-out, box-shadow 0.15s ease-out;

      width: 48px;
      height: 40px;
      font-size: 18px; /* Globe symbol size */
      font-weight: 500;
      background: #ffffff;
      color: var(--text-main);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border-radius: 999px;
    }

    #lang-toggle-btn:hover {
        background: #fff5ec;
    }

    #lang-options {
      display: flex;
      flex-direction: column; 
      gap: 4px;
      margin-top: 4px;
      padding: 4px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.7);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      backdrop-filter: blur(4px);
      /* Transition for smooth display */
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      transition: opacity 0.2s, visibility 0.2s, transform 0.2s;
    }

    #lang-options.hidden {
      opacity: 0;
      visibility: hidden;
      transform: translateY(-5px);
    }
    
    .lang-btn {
      border: none;
      background: none;
      color: var(--text-main);
      font-weight: 500;
      font-size: 14px;
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
      transition: background 0.15s ease-out, color 0.15s ease-out;
      width: 48px; 
    }

    .lang-btn.active {
      background: var(--accent);
      color: white;
      font-weight: 700;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .lang-btn:not(.active):hover {
      background: rgba(255, 121, 0, 0.1);
    }

    /* *** TOOLTIP STYLES *** */
    .tooltip {
      position: fixed; 
      pointer-events: none;
      background: rgba(255, 255, 255, 0.92);
      color: #333333;
      padding: 12px 18px;
      font-size: 15px;
      border-radius: 10px;
      opacity: 0;
      transform: translate(0, 0);
      transition: opacity 0.12s ease-out;
      box-shadow: 0 6px 22px rgba(0, 0, 0, 0.16);
      border: 1px solid rgba(0, 0, 0, 0.05);
      z-index: 9999;
      max-width: 360px; /* Standard max-width on desktop */
      white-space: normal;
      backdrop-filter: blur(4px);
      top: 0;
      left: 0;
      display: none;
    }

    .tooltip-country {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 18px; /* INCREASED GAP */
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #222222;
    }

    .tooltip-metric {
      margin-top: 14px; /* Slightly increased gap between metrics */
      padding-left: 10px;
      border-left: 4px solid rgba(0, 0, 0, 0.15);
    }

    .tooltip-metric-title {
      font-weight: 900; /* BOLDER */
      font-size: 15px; /* Slightly increased */
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #111111; /* Darker color */
      margin-bottom: 3px; /* Small gap below title */
    }

    .tooltip-metric-text {
      font-size: 13.5px; /* Slightly smaller for better hierarchy */
      line-height: 1.5;
      color: #555555;
    }
    
    /* Remaining Styles */

    .page {
      min-height: 100vh;
      height: 100%;
      padding: 32px 2vw 40px;
      display: flex;
      flex-direction: column; /* Added to accommodate the footer */
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 32px;
      height: 100%;
    }

    .hero {
      flex: 1;
      width: 100%;
      max-width: 1300px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 16px;
      min-height: min(100vh, 900px);
    }

    .page-header {
      width: 100%;
      max-width: 1200px;
      margin: 0 0 8px;
      padding-bottom: 0;
      text-align: left;
    }

    .eyebrow {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 8px;
    }

    /* TITLE SIZE ADJUSTMENT (15% smaller) */
    .page-header h1 {
      margin: 0;
      font-size: clamp(1.95rem, 2.55vw, 2.55rem);
      font-weight: 900;
      line-height: 1.15;
      color: #222222;
    }

    .header-rule {
      display: none;
    }

    /* SUBTITLE SIZE ADJUSTMENT (15% smaller) */
    .subtitle-block {
      max-width: 1200px;
      font-size: 1.0625rem; 
      line-height: 1.3;
      text-align: left;
      margin-bottom: 1.5rem;
    }

    .subtitle-block p {
      margin: 0;
      color: #555555;
    }

    .subtitle-block p strong {
      font-weight: 700;
      color: #333333;
    }

    #map-section {
      width: 100%;
      max-width: none;
      margin: 16px 0 0;
      position: relative;
      /* Adjusted for better desktop/large screen experience */
      height: min(80vh, 900px); 
      overflow: hidden; 

      border-radius: 0;
      box-shadow: none;
      background: none;
      border: none;

      align-self: stretch;
      margin-top: auto;
    }

    #map-container {
      width: 100%;
      height: 100%;
      position: relative;
    }

    svg {
      width: 100%;
      height: 100%;
      cursor: grab;
      touch-action: none; 
    }

    svg:active {
      cursor: grabbing;
    }

    .graticule {
      fill: none;
      stroke: rgba(255, 255, 255, 0.25);
      stroke-width: 0.5;
      stroke-dasharray: 2 3;
    }

    .country {
      fill: #555555;
      stroke: #ffffff;
      stroke-width: 0.45;
      transition: fill 0.15s ease-out, stroke 0.15s ease-out, transform 0.15s ease-out;
      cursor: pointer;
    }

    .country:hover {
      fill: #b5b5b5;
      stroke: #f0f0f0;
      transform: translateY(-0.5px);
    }
    
    /* ZOOM + RESET + PAUSE CONTROLS (Updated font size for consistency) */
    .zoom-controls {
      position: absolute;
      left: 18px;
      top: 18px; 
      bottom: auto; 
      display: inline-flex;
      flex-direction: row; 
      gap: 8px; 
      padding: 8px; 
      border-radius: 999px;
      background: none;
      box-shadow: none;
      border: none;
      backdrop-filter: none;
      z-index: 5;
    }

    .zoom-btn {
      border: none;
      width: 40px; 
      height: 40px; 
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px; /* Unified size for all desktop symbols */
      font-weight: 600;
      cursor: pointer;
      background: #ffffff;
      color: #444444;
      transition: background 0.15s ease-out, box-shadow 0.15s ease-out, transform 0.1s ease-out;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.12);
    }

    .zoom-btn:hover {
      background: #fff5ec;
      transform: translateY(-1px);
      box-shadow: 0 5px 14px rgba(0, 0, 0, 0.16);
    }

    .zoom-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
    }

    /* Keep specific symbol size if needed, but the main one should cover it */
    .zoom-reset {
        font-size: 20px; /* Slightly smaller for the loop symbol */
    }
    
    /* *** NEW STYLES FOR SOURCES FOOTER *** */
    .page-footer {
      width: 100%;
      max-width: 1300px;
      margin: 20px auto 0;
      padding: 20px 0 0;
      border-top: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .sources {
      font-size: 11.5px; /* Small font */
      line-height: 1.4;
      color: #888888; /* Grey font */
      margin: 0;
    }
    
    .sources a {
      color: #888888;
      text-decoration: underline;
      transition: color 0.15s;
    }
    
    .sources a:hover {
        color: var(--accent);
    }
    /* ---------------------------------
       UNIVERSAL RESPONSIVENESS REFINEMENTS
       --------------------------------- */
    @media (max-width: 700px) {
      .page {
        padding: 16px 4vw 20px; /* Tighter padding on mobile */
      }
      /* Title and Subtitle */
      .page-header h1 {
        font-size: clamp(1.6rem, 6.5vw, 2.2rem); 
      }
      .subtitle-block {
        font-size: 1rem; /* Base 16px on mobile */
        margin-bottom: 1rem;
      }
      
      /* Map Section Flexibility */
      #map-section {
        height: 75vh; /* Use 75% of viewport height */
        min-height: 300px; /* Prevent collapse on content-heavy screens */
        margin-top: 8px;
      }

      /* Controls Tighter Positioning */
      .zoom-controls {
        left: 8px; 
        top: 8px;              
        gap: 6px; 
        padding: 6px;
      }
      .zoom-btn {
        width: 36px; 
        height: 36px; 
        font-size: 18px; /* Mobile font size */
      }
      /* Reduce size for reset symbol on mobile */
      .zoom-reset {
        font-size: 16px;
      }
      
      /* Language Switch Tighter Positioning */
      #language-switch {
        top: 10px;
        right: 4vw;
      }
      #lang-toggle-btn {
        width: 40px; 
        height: 32px;
        font-size: 16px;
      }
      #lang-options {
        padding: 3px;
        margin-top: 3px;
      }
      .lang-btn {
        font-size: 12px;
        padding: 4px 6px;
        width: 40px; 
      }
      
      /* Tooltip full width usage */
      .tooltip {
        padding: 10px 14px;
        font-size: 14px;
        max-width: 90vw; 
      }
      
      /* Mobile source text */
      .page-footer {
        padding-top: 15px;
      }
      .sources {
        font-size: 10.5px;
      }
    }
  </style>
</head>

<body>
  <div id="language-switch">
    <button id="lang-toggle-btn" class="lang-btn toggle-btn" title="Select Language">üåê</button>
    
    <div id="lang-options" class="lang-options hidden">
      <button class="lang-btn active" data-lang="en">EN</button>
      <button class="lang-btn" data-lang="de">DE</button>
    </div>
  </div>
  
  <div id="tooltip" class="tooltip"></div> 

  <div class="page">
    <main>
      <section class="hero">
        <header class="page-header">
          <div class="eyebrow" id="text-eyebrow"></div>
          <h1 id="text-header"></h1>
          <div class="header-rule"></div>
        </header>

        <section class="subtitle-block">
          <p id="text-subtitle"></p>
        </section>

        <div id="globe-diagnostics" style="font-family: sans-serif; font-size: 14px; 
             background: #111; color: #fff; padding: 12px; margin: 0 0 16px 0; border-radius: 6px; display:none;">
        </div>
        
        <section id="map-section">
          <div id="map-container"></div>
          
          <div class="zoom-controls">
            <button class="zoom-btn zoom-pause-toggle" id="pause-toggle-btn" type="button" title="Stop spinning">&#x25A0;</button>
            <button class="zoom-btn" data-zoom="in" type="button" title="Zoom In">&#x2295;</button>
            <button class="zoom-btn" data-zoom="out" type="button" title="Zoom Out">&#x2296;</button>
            <button class="zoom-btn zoom-reset" id="reset-btn" type="button" title="Reset globe">‚ü≤</button>
          </div>
        </section>
      </section>
    </main>
    
    <footer class="page-footer">
        <p class="sources" id="text-sources"></p>
    </footer>
    
  </div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>

  <script>
    const container = d3.select("#map-container");
    const tooltip = d3.select("#tooltip");
    const svg = container.append("svg");
    const svgNode = svg.node(); 
    let currentLang = 'en';

    // *** LANGUAGE DATA STRUCTURE ***
    const languageData = {
        en: {
            title: "Interactive Globe ‚Äì Intercultural Communication 3D",
            eyebrow: "Infographic",
            header: "A Survival Guide for Intercultural Communication",
            subtitle: "Have you ever been in a conversation and felt misunderstood? Don‚Äôt worry, this is not always due to poor grammar or lack of vocabulary; it is often simply a question of Intercultural Communication. <strong>Click any country on the globe to reveal its behavioral pattern.</strong>",
            stopTitle: "Stop spinning",
            startTitle: "Start spinning",
            resetTitle: "Reset globe",
            tooltipNoData: "No data for this country in this analysis.",
            tooltipNoMetrics: "This country is included in the matrix, but no metrics are ticked.",
            sources: 'Sources: ‚ÄúInterethnic communication‚Äù John Gumperz, ‚ÄúCultures and organizations: Software of the Mind‚Äù Hofsted, Various works by Edward T. Hall, <a href="https://www.acc.com/sites/default/files/2021-08/Presentation%20The%20culture%20map-%20Breaking%20through%20the%20invisible%20boundaries%20of%20global%20business%20.pdf" target="_blank">The culture map - Breaking through the invisible boundaries of global business (PDF)</a>.',
            metrics: {
                group_culture: {
                    title: "Group Culture",
                    color: "#cd5b00",
                    description: "The group, or ‚Äúwe,‚Äù has priority. Relationships are based on loyalty and selectivity."
                },
                individual_culture: {
                    title: "Individual Culture",
                    color: "#ff7900",
                    description: "The focus is on the individual and self-expression. Personal goals take priority."
                },
                speaking_implicity: {
                    title: "Speaking Implicity",
                    color: "#03649f",
                    description: "Messages are veiled; more is implied than said. A ‚Äúyes‚Äù might simply be polite."
                },
                explicit_language: {
                    title: "Explicit Language",
                    color: "#038bc7",
                    description: "Communication is direct: a yes is a yes, a no is a no."
                },
                hierarchical_culture: {
                    title: "Hierarchical Culture",
                    color: "#d79d00",
                    description: "Hierarchy matters greatly and shapes how people speak and who speaks first."
                },
                informal_culture: {
                    title: "Informal Culture",
                    color: "#f5c500",
                    description: "An informal setting where uncertainty and change are handled calmly and casually."
                },
                focus_time: {
                    title: "Focus on Time",
                    color: "#98bc36",
                    description: "Monochronic cultures prioritize sticking to a specific timeframe."
                },
                culture_uncertainty: {
                    title: "Culture of Uncertainty",
                    color: "#039a82",
                    description: "People accept the unknown and change more calmly. Rules are more flexible."
                },
                change_management: {
                    title: "Change Management",
                    color: "#036f64",
                    description: "Change can feel threatening; strict rules help people feel in control and motivated."
                },
                focus_task: {
                    title: "Focus on Task",
                    color: "#70940e",
                    description: "Polychronic cultures prioritize completing the task, even if this means delays."
                }
            }
        },
        de: {
            title: "Interaktiver Globus ‚Äì Interkulturelle Kommunikation 3D",
            eyebrow: "Infografik",
            header: "Ein √úberlebensleitfaden f√ºr Interkulturelle Kommunikation",
            subtitle: "Haben Sie sich jemals in einem Gespr√§ch missverstanden gef√ºhlt? Machen Sie sich keine Sorgen, das liegt nicht immer an schlechter Grammatik oder fehlendem Vokabular; es ist oft einfach eine Frage der Interkulturellen Kommunikation. <strong>Klicken Sie auf ein Land auf dem Globus, um dessen Verhaltensmuster anzuzeigen.</strong>",
            stopTitle: "Drehen stoppen",
            startTitle: "Drehen starten",
            resetTitle: "Globus zur√ºcksetzen",
            tooltipNoData: "Keine Daten f√ºr dieses Land in dieser Analyse.",
            tooltipNoMetrics: "Dieses Land ist in der Matrix enthalten, aber es sind keine Kennzahlen markiert.",
            sources: 'Quellen: ‚ÄûInterethnic communication‚Äú John Gumperz, ‚ÄûCultures and organizations: Software of the Mind‚Äú Hofsted, Verschiedene Werke von Edward T. Hall, <a href="https://www.acc.com/sites/default/files/2021-08/Presentation%20The%20culture%20map-%20Breaking%20through%20the%20invisible%20boundaries%20of%20global%20business%20.pdf" target="_blank">The culture map - Breaking through the invisible boundaries of global business (PDF)</a>.',
            metrics: {
                group_culture: {
                    title: "Gruppenkultur",
                    color: "#cd5b00",
                    description: "Die Gruppe, oder ‚Äûwir‚Äú, hat Priorit√§t. Beziehungen basieren auf Loyalit√§t und Selektivit√§t."
                },
                individual_culture: {
                    title: "Individualkultur",
                    color: "#ff7900",
                    description: "Der Fokus liegt auf dem Individuum und der Selbstentfaltung. Pers√∂nliche Ziele haben Vorrang."
                },
                speaking_implicity: {
                    title: "Implizite Sprache",
                    color: "#03649f",
                    description: "Botschaften sind verschleiert; es wird mehr impliziert als gesagt. Ein ‚ÄûJa‚Äú kann einfach nur h√∂flich sein."
                },
                explicit_language: {
                    title: "Explizite Sprache",
                    color: "#038bc7",
                    description: "Die Kommunikation ist direkt: Ein Ja ist ein Ja, ein Nein ist ein Nein."
                },
                hierarchical_culture: {
                    title: "Hierarchische Kultur",
                    color: "#d79d00",
                    description: "Hierarchie ist von gro√üer Bedeutung und pr√§gt, wie Menschen sprechen und wer zuerst spricht."
                },
                informal_culture: {
                    title: "Informelle Kultur",
                    color: "#f5c500",
                    description: "Ein informelles Umfeld, in dem Unsicherheit und Wandel gelassen und zwanglos gehandhabt werden."
                },
                focus_time: {
                    title: "Zeitfokus",
                    color: "#98bc36",
                    description: "Monochrone Kulturen legen Wert darauf, sich an einen bestimmten Zeitrahmen zu halten."
                },
                culture_uncertainty: {
                    title: "Unsicherheitskultur",
                    color: "#039a82",
                    description: "Menschen akzeptieren das Unbekannte und Ver√§nderungen gelassener. Regeln sind flexibler."
                },
                change_management: {
                    title: "Umgang mit Ver√§nderungen",
                    color: "#036f64",
                    description: "Ver√§nderungen k√∂nnen bedrohlich wirken; strenge Regeln helfen den Menschen, sich kontrolliert und motiviert zu f√ºhlen."
                },
                focus_task: {
                    title: "Aufgabenfokus",
                    color: "#70940e",
                    description: "Polychrone Kulturen legen Wert darauf, die Aufgabe zu erledigen, auch wenn dies zu Verz√∂gerungen f√ºhrt."
                }
            }
        }
    };


    // ----- COUNTRY ‚Üí METRICS MAPPING (Unchanged) -----
    const countryMetrics = {
      "Afghanistan": ["speaking_implicity","focus_task"], "Algeria": ["speaking_implicity","focus_task"], 
      "Angola": ["speaking_implicity","focus_task"], "Argentina": ["speaking_implicity"], 
      "Australia": ["individual_culture","explicit_language","informal_culture","focus_time","change_management"], 
      "Austria": ["individual_culture","explicit_language","focus_time","culture_uncertainty"], 
      "Azerbaijan": ["group_culture","speaking_implicity","focus_task"], 
      "Bangladesh": ["group_culture","speaking_implicity","focus_task"], 
      "Belarus": ["group_culture","speaking_implicity","hierarchical_culture","focus_time","focus_task"], 
      "Belgium": ["individual_culture","explicit_language","focus_time","culture_uncertainty"], 
      "Bolivia": ["group_culture","speaking_implicity","focus_task"], 
      "Bosnia and Herzegovina": ["group_culture","speaking_implicity","hierarchical_culture","focus_task"], 
      "Botswana": ["group_culture","speaking_implicity","focus_task"], 
      "Brazil": ["group_culture","speaking_implicity","informal_culture","focus_task"], 
      "Bulgaria": ["group_culture","speaking_implicity","hierarchical_culture","focus_task"], 
      "Burkina Faso": ["group_culture","speaking_implicity","focus_task"], 
      "Burundi": ["group_culture","speaking_implicity","focus_task"], 
      "Cambodia": ["group_culture","speaking_implicity","hierarchical_culture","focus_task"], 
      "Cameroon": ["group_culture","speaking_implicity","focus_task"], 
      "Canada": ["individual_culture","explicit_language","informal_culture","focus_time","culture_uncertainty"], 
      "Central African Republic": ["group_culture","speaking_implicity","focus_task"], 
      "Chad": ["group_culture","speaking_implicity","focus_task"], 
      "Chile": ["group_culture","speaking_implicity"], 
      "China": ["group_culture","speaking_implicity","hierarchical_culture","focus_time"], 
      "Colombia": ["group_culture","speaking_implicity","focus_task"], 
      "Congo": ["group_culture","speaking_implicity","focus_task"], 
      "Costa Rica": ["group_culture","speaking_implicity","focus_task"], 
      "Croatia": ["group_culture","speaking_implicity","hierarchical_culture","focus_task"], 
      "Cuba": ["group_culture","speaking_implicity","focus_task"], 
      "Czech Republic": ["individual_culture","explicit_language","focus_time"], 
      "Denmark": ["individual_culture","explicit_language","culture_uncertainty","focus_task"], 
      "Dominican Republic": ["group_culture","speaking_implicity","focus_task"], 
      "DR Congo": ["group_culture","speaking_implicity","focus_task"], 
      "Ecuador": ["group_culture","speaking_implicity"], 
      "Egypt": ["group_culture","speaking_implicity","hierarchical_culture","focus_task"], 
      "El Salvador": ["group_culture","speaking_implicity","focus_task"], 
      "Equatorial Guinea": ["group_culture","speaking_implicity","focus_task"], 
      "Eritrea": ["group_culture","speaking_implicity","focus_task"], 
      "Estonia": ["individual_culture","explicit_language","focus_time","culture_uncertainty"], 
      "Ethiopia": ["group_culture","speaking_implicity","focus_task"], 
      "Finland": ["individual_culture","explicit_language","focus_time"], 
      "France": ["individual_culture","explicit_language","informal_culture","focus_time"], 
      "Gabon": ["group_culture","speaking_implicity","focus_task"], 
      "Gambia": ["group_culture","speaking_implicity","focus_task"], 
      "Georgia": ["group_culture","speaking_implicity","focus_task"], 
      "Germany": ["individual_culture","explicit_language","focus_time","culture_uncertainty","focus_task"], 
      "Ghana": ["group_culture","speaking_implicity","focus_task"], 
      "Greece": ["group_culture","speaking_implicity","hierarchical_culture","focus_time","focus_task"], 
      "Guatemala": ["group_culture","speaking_implicity","focus_task"], 
      "Guinea": ["group_culture","speaking_implicity","focus_task"], 
      "Guinea Bissau": ["group_culture","speaking_implicity","focus_task"], 
      "Guyana": ["group_culture","speaking_implicity","focus_task"], 
      "Haiti": ["group_culture","speaking_implicity","focus_task"], 
      "Honduras": ["group_culture","speaking_implicity","focus_task"], 
      "Hungary": ["group_culture","speaking_implicity","hierarchical_culture","focus_time"], 
      "Iceland": ["individual_culture","explicit_language","culture_uncertainty","focus_task"], 
      "India": ["group_culture","speaking_implicity","hierarchical_culture","focus_task"], 
      "Indonesia": ["group_culture","speaking_implicity","focus_task"], 
      "Iran": ["group_culture","speaking_implicity","hierarchical_culture","focus_time","focus_task"], 
      "Iraq": ["group_culture","speaking_implicity","focus_task"], 
      "Ireland": ["individual_culture","explicit_language","informal_culture","focus_time","culture_uncertainty"], 
      "Israel": ["individual_culture","explicit_language","informal_culture","focus_time","culture_uncertainty"], 
      "Italy": ["group_culture","speaking_implicity","informal_culture","focus_time"], 
      "Ivory Coast": ["group_culture","speaking_implicity","focus_task"], 
      "Jamaica": ["group_culture","speaking_implicity","informal_culture","focus_task"], 
      "Japan": ["group_culture","speaking_implicity","hierarchical_culture","focus_time"], 
      "Jordan": ["group_culture","speaking_implicity","focus_task"], 
      "Kazakhstan": ["group_culture","speaking_implicity","hierarchical_culture","focus_time","focus_task"], 
      "Kenya": ["group_culture","speaking_implicity","focus_task"], 
      "Kuwait": ["group_culture","speaking_implicity","hierarchical_culture","focus_task"], 
      "Kyrgyzstan": ["group_culture","speaking_implicity","focus_task"], 
      "Laos": ["group_culture","speaking_implicity","focus_task"], 
      "Latvia": ["individual_culture","explicit_language","focus_time","culture_uncertainty"], 
      "Lebanon": ["group_culture","speaking_implicity","focus_task"], 
      "Lesotho": ["group_culture","speaking_implicity","focus_task"], 
      "Liberia": ["group_culture","speaking_implicity","focus_task"], 
      "Libya": ["group_culture","speaking_implicity","focus_task"], 
      "Lithuania": ["individual_culture","explicit_language","focus_time","culture_uncertainty"], 
      "Luxembourg": ["individual_culture","explicit_language","focus_time"], 
      "Macedonia": ["group_culture","speaking_implicity","focus_task"], 
      "Madagascar": ["group_culture","speaking_implicity","focus_task"], 
      "Malawi": ["group_culture","speaking_implicity","focus_task"], 
      "Malaysia": ["group_culture","speaking_implicity","hierarchical_culture","focus_time","focus_task"], 
      "Mali": ["group_culture","speaking_implicity","focus_task"], 
      "Mauritania": ["group_culture","speaking_implicity","focus_task"], 
      "Mexico": ["group_culture","speaking_implicity","focus_task"], 
      "Moldova": ["group_culture","speaking_implicity","focus_task"], 
      "Mongolia": ["group_culture","speaking_implicity","focus_task"], 
      "Montenegro": ["group_culture","speaking_implicity","focus_task"], 
      "Morocco": ["group_culture","speaking_implicity","focus_task"], 
      "Mozambique": ["group_culture","speaking_implicity","focus_task"], 
      "Myanmar": ["group_culture","speaking_implicity","focus_task"], 
      "Namibia": ["group_culture","speaking_implicity","focus_task"], 
      "Nepal": ["group_culture","speaking_implicity","focus_task"], 
      "Netherlands": ["individual_culture","explicit_language","culture_uncertainty","focus_task"], 
      "New Zealand": ["individual_culture","explicit_language","informal_culture","focus_time","culture_uncertainty"], 
      "Nicaragua": ["group_culture","speaking_implicity","focus_task"], 
      "Niger": ["group_culture","speaking_implicity","focus_task"], 
      "Nigeria": ["group_culture","speaking_implicity","informal_culture","focus_task"], 
      "North Korea": ["group_culture","speaking_implicity","hierarchical_culture","focus_time","focus_task"], 
      "Norway": ["individual_culture","explicit_language","culture_uncertainty","focus_task"], 
      "Oman": ["group_culture","speaking_implicity","focus_task"], 
      "Pakistan": ["group_culture","speaking_implicity","hierarchical_culture","focus_task"], 
      "Panama": ["group_culture","speaking_implicity","focus_task"], 
      "Papua New Guinea": ["group_culture","speaking_implicity","focus_task"], 
      "Paraguay": ["group_culture","speaking_implicity"], 
      "Peru": ["group_culture","speaking_implicity","focus_task"], 
      "Philippines": ["group_culture","speaking_implicity","focus_task"], 
      "Poland": ["group_culture","speaking_implicity","hierarchical_culture","focus_time","focus_task"], 
      "Portugal": ["group_culture","speaking_implicity","focus_time","focus_task"], 
      "Puerto Rico": ["group_culture","speaking_implicity","focus_task"], 
      "Qatar": ["group_culture","speaking_implicity","focus_task"], 
      "Romania": ["group_culture","speaking_implicity","hierarchical_culture","focus_time"], 
      "Russia": ["group_culture","speaking_implicity","hierarchical_culture","focus_time","focus_task"], 
      "Rwanda": ["group_culture","speaking_implicity","focus_task"], 
      "Saudi Arabia": ["group_culture","speaking_implicity","hierarchical_culture","focus_task"], 
      "Senegal": ["group_culture","speaking_implicity","focus_task"], 
      "Serbia": ["group_culture","speaking_implicity","hierarchical_culture","focus_task"], 
      "Sierra Leone": ["group_culture","speaking_implicity","focus_task"], 
      "Slovakia": ["group_culture","speaking_implicity","hierarchical_culture","focus_time"], 
      "Slovenia": ["individual_culture","explicit_language","focus_time","culture_uncertainty"], 
      "Somalia": ["group_culture","speaking_implicity","focus_task"], 
      "South Africa": ["group_culture","speaking_implicity","informal_culture","focus_task"], 
      "South Korea": ["group_culture","speaking_implicity","hierarchical_culture","focus_time"], 
      "South Sudan": ["group_culture","speaking_implicity","focus_task"], 
      "Spain": ["group_culture","speaking_implicity","informal_culture","focus_time","focus_task"], 
      "Sri Lanka": ["group_culture","speaking_implicity","focus_task"], 
      "Sudan": ["group_culture","speaking_implicity","focus_task"], 
      "Suriname": ["group_culture","speaking_implicity","focus_task"], 
      "Swaziland": ["group_culture","speaking_implicity","focus_task"], 
      "Sweden": ["individual_culture","explicit_language","culture_uncertainty","focus_task"], 
      "Switzerland": ["individual_culture","explicit_language","focus_time"], 
      "Syria": ["group_culture","speaking_implicity","focus_task"], 
      "Taiwan": ["group_culture","speaking_implicity","hierarchical_culture","focus_time"], 
      "Tajikistan": ["group_culture","speaking_implicity","focus_task"], 
      "Tanzania": ["group_culture","speaking_implicity","focus_task"], 
      "Thailand": ["group_culture","speaking_implicity","focus_task"], 
      "Togo": ["group_culture","speaking_implicity","focus_task"], 
      "Trinidad and Tobago": ["group_culture","speaking_implicity","focus_task"], 
      "Tunisia": ["group_culture","speaking_implicity","focus_task"], 
      "Turkey": ["group_culture","speaking_implicity","hierarchical_culture","focus_time","focus_task"], 
      "Turkmenistan": ["group_culture","speaking_implicity","focus_task"], 
      "Uganda": ["group_culture","speaking_implicity","focus_task"], 
      "Ukraine": ["group_culture","speaking_implicity","hierarchical_culture","focus_time","focus_task"], 
      "United Arab Emirates": ["group_culture","speaking_implicity","hierarchical_culture","focus_task"], 
      "United Kingdom": ["individual_culture","explicit_language","informal_culture","focus_time","culture_uncertainty"], 
      "United States": ["individual_culture","explicit_language","informal_culture","focus_time","change_management"], 
      "Uruguay": ["group_culture","speaking_implicity","focus_task"], 
      "Uzbekistan": ["group_culture","speaking_implicity","focus_task"], 
      "Venezuela": ["group_culture","speaking_implicity","focus_task"], 
      "Vietnam": ["group_culture","speaking_implicity","focus_task"], 
      "Western Sahara": ["group_culture","speaking_implicity","focus_task"], 
      "Yemen": ["group_culture","speaking_implicity","focus_task"], 
      "Zambia": ["group_culture","speaking_implicity","focus_task"], 
      "Zimbabwe": ["focus_task"]
    };

    // ----- ALIASES: TopoJSON name -> matrix name (Unchanged) -----
    const countryNameAliases = {
      "United States of America": "United States",
      "C√¥te d'Ivoire": "Ivory Coast",
      "Czechia": "Czech Republic",
      "Eswatini": "Swaziland",
      "Democratic Republic of the Congo": "DR Congo",
      "Dem. Rep. Congo": "DR Congo",
      "Central African Rep.": "Central African Republic",
      "Eq. Guinea": "Equatorial Guinea",
      "Guinea-Bissau": "Guinea Bissau",
      "Republic of the Congo": "Congo"
    };

    function resolveCountryKey(countryName) {
      if (countryMetrics[countryName]) {
        return { key: countryName, inList: true };
      }
      const alias = countryNameAliases[countryName];
      if (alias && countryMetrics[alias]) {
        return { key: alias, inList: true };
      }
      return { key: countryName, inList: false };
    }

    // *** LANGUAGE UPDATE FUNCTION ***
    function updateLanguage(lang) {
        currentLang = lang;
        const data = languageData[lang];

        // 1. Update static page text
        d3.select("#page-title").text(data.title);
        d3.select("#text-eyebrow").text(data.eyebrow);
        d3.select("#text-header").text(data.header);
        d3.select("#text-subtitle").html(data.subtitle);
        d3.select("#text-sources").html(data.sources); // <-- New: Update sources text

        // 2. Update button titles
        const pauseBtn = d3.select("#pause-toggle-btn");
        d3.select("#reset-btn").attr("title", data.resetTitle);
        if (isSpinning) {
             pauseBtn.attr("title", data.stopTitle);
        } else {
             pauseBtn.attr("title", data.startTitle);
        }

        // 3. Update language switch buttons
        d3.selectAll(".lang-btn:not(.toggle-btn)").classed("active", function() {
            return d3.select(this).attr("data-lang") === lang;
        });

        // 4. Hide tooltip if visible, since its content language would change
        tooltip.style("opacity", 0).style("display", "none");
    }

    // JavaScript logic for language toggle
    const langOptions = d3.select("#lang-options");
    const langToggleBtn = d3.select("#lang-toggle-btn");

    // 1. Toggle visibility of language options on globe click
    langToggleBtn.on("click", () => {
        const isHidden = langOptions.classed("hidden");
        langOptions.classed("hidden", !isHidden);
    });

    // 2. Event listener for actual language buttons (excludes the globe toggle button)
    d3.selectAll(".lang-btn:not(.toggle-btn)").on("click", (event) => {
        const lang = event.currentTarget.dataset.lang;
        updateLanguage(lang);
        // Hide options after selection
        langOptions.classed("hidden", true);
    });


    // ----- D3 Setup (Unchanged) -----
    const defs = svg.append("defs");
    const globeGradient = defs.append("radialGradient")
      .attr("id", "globeGradient")
      .attr("cx", "30%")
      .attr("cy", "30%")
      .attr("r", "70%");
    globeGradient.append("stop").attr("offset", "0%").attr("stop-color", "#fffdf9");
    globeGradient.append("stop").attr("offset", "60%").attr("stop-color", "#ffe8d0");
    globeGradient.append("stop").attr("offset", "100%").attr("stop-color", "#ffd2a1");
    const glowFilter = defs.append("filter")
      .attr("id", "globeGlow")
      .attr("x", "-50%")
      .attr("y", "-50%")
      .attr("width", "200%")
      .attr("height", "200%");
    glowFilter.append("feGaussianBlur")
      .attr("in", "SourceGraphic")
      .attr("stdDeviation", 25)
      .attr("result", "blur");
    glowFilter.append("feMerge")
      .selectAll("feMergeNode")
      .data(["blur"])
      .enter()
      .append("feMergeNode")
      .attr("in", d => d);
    const clipPath = defs.append("clipPath").attr("id", "globeClip");
    const clipCircle = clipPath.append("circle");
    const globeGroup = svg.append("g");
    const landGroup = svg.append("g").attr("clip-path", "url(#globeClip)");
    const globeGlowCircle = globeGroup.append("circle")
      .attr("fill", "#ffffff")
      .attr("opacity", 0.9)
      .attr("filter", "url(#globeGlow)");
    const globeSphere = globeGroup.append("circle")
      .attr("class", "globe-sphere")
      .attr("fill", "url(#globeGradient)");

    // Globe State
    const initialRotation = [0, -10, 0];
    const projection = d3.geoOrthographic()
      .rotate(initialRotation.slice())
      .precision(0.5);
    const path = d3.geoPath().projection(projection);
    const graticule = d3.geoGraticule();

    let worldFeature = null;
    let rotation = projection.rotate().slice();
    let isDragging = false;
    let isHovering = false; // Flag to stop spinning when mouse is over a country/tooltip
    let isClicking = false; 

    // Zoom state
    let zoomFactor = 1;
    const zoomMin = 0.6;
    const zoomMax = 2.5;
    const zoomStep = 0.15;
    let baseRadius = 1;

    // Pinch-to-zoom state
    let pinchStartDistance = null;
    let initialZoomFactorForPinch = 1;

    // Spinning State
    let isSpinning = true; 
    const pauseToggleBtn = d3.select("#pause-toggle-btn");

    function redrawGlobe() {
      landGroup.selectAll("path").attr("d", path);
    }

    function resizeGlobe() {
      const rect = container.node().getBoundingClientRect();
      const width = rect.width;
      const height = rect.height;

      svg.attr("width", width).attr("height", height);

      // Globe large + slightly pushed down so lower ~10‚Äì15% is cropped
      baseRadius = Math.min(width, height * 1.3) / 2;
      const radius = baseRadius * zoomFactor;

      const cx = width / 2;
      const cy = height / 2 + radius * 0.12;

      // Glow circle slightly larger than globe
      globeGlowCircle
        .attr("cx", cx)
        .attr("cy", cy)
        .attr("r", radius * 1.15);

      globeSphere
        .attr("cx", cx)
        .attr("cy", cy)
        .attr("r", radius);

      clipCircle
        .attr("cx", cx)
        .attr("cy", cy)
        .attr("r", radius);

      projection.translate([cx, cy]).scale(radius).rotate(rotation);

      if (worldFeature) redrawGlobe();
    }

    function setZoom(newZoom) {
      zoomFactor = Math.max(zoomMin, Math.min(zoomMax, newZoom));
      resizeGlobe();
    }

    // Drag to rotate (Single touch/mouse)
    let dragStart = null;
    let rotationStart = null;

    const drag = d3.drag()
      .on("start", (event) => {
        if (event.touches && event.touches.length > 1 || isClicking || pinchStartDistance !== null) return; 

        isDragging = true;
        const r = projection.rotate();
        rotationStart = [r[0], r[1], r[2] || 0];
        dragStart = [event.x, event.y];
        tooltip.style("opacity", 0).style("display", "none"); 
        isHovering = false;
      })
      .on("drag", (event) => {
        if (pinchStartDistance !== null) return;
        if (!dragStart || !rotationStart || isClicking) return;

        const sensitivity = 0.25;
        const dx = event.x - dragStart[0];
        const dy = event.y - dragStart[1];

        let lambda = rotationStart[0] + dx * sensitivity;
        let phi = rotationStart[1] - dy * sensitivity;
        phi = Math.max(-80, Math.min(80, phi));

        rotation = [lambda, phi, rotationStart[2] || 0];
        projection.rotate(rotation);
        redrawGlobe();
      })
      .on("end", () => {
        isDragging = false;
        dragStart = null;
        rotationStart = null;
        rotation = projection.rotate().slice();
      });

    svg.call(drag);


    // ----- PINCH-TO-ZOOM LOGIC (Mobile) -----
    
    // Helper function to calculate distance between two touches
    function getDistance(touches) {
      if (touches.length < 2) return 0;
      const dx = touches[0].clientX - touches[1].clientX;
      const dy = touches[0].clientY - touches[1].clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }
    
    // 1. TOUCHSTART: Initialize pinch
    svgNode.addEventListener('touchstart', (event) => {
        if (event.touches.length === 2) {
            event.preventDefault(); 
            isDragging = false;
            dragStart = null;
            rotationStart = null;
            pinchStartDistance = getDistance(event.touches);
            initialZoomFactorForPinch = zoomFactor;

            tooltip.style("opacity", 0).style("display", "none");
            isHovering = false;
            isClicking = false; 
        }
    }, {passive: false}); 
    
    // 2. TOUCHMOVE: Perform zoom calculation
    svgNode.addEventListener('touchmove', (event) => {
        if (event.touches.length === 2 && pinchStartDistance !== null) {
            event.preventDefault(); 

            const currentDistance = getDistance(event.touches);
            const ratio = currentDistance / pinchStartDistance;
            
            const newZoom = initialZoomFactorForPinch * ratio;
            setZoom(newZoom); 
        }
    }, {passive: false}); 

    // 3. TOUCHEND: Reset pinch state
    svgNode.addEventListener('touchend', (event) => {
        if (pinchStartDistance !== null && event.touches.length < 2) {
            pinchStartDistance = null;
            initialZoomFactorForPinch = 1;
        }
    });
    
    // ------------------------------------------

    // Auto-rotation with smooth restart
    const autoSpeed = 0.01; // base deg/ms
    let lastTime = Date.now();
    let idleTime = 0; // ms since last hover/drag/pinch

    d3.timer(() => {
      if (!worldFeature) return;
      const now = Date.now();
      const dt = now - lastTime;
      lastTime = now;

      // The globe only spins if it's set to spin AND there are no active interactions
      if (isSpinning && !isDragging && !isHovering && !isClicking && pinchStartDistance === null) {
        idleTime = Math.min(idleTime + dt, 3000); 
        const factor = Math.min(idleTime / 1500, 1); 
        rotation[0] += autoSpeed * dt * factor;
        projection.rotate(rotation);
        redrawGlobe();
      } else {
        // If an interaction is active (including isHovering), reset the idle timer
        idleTime = 0;
      }
    });

    // Zoom buttons (+ / -)
    d3.selectAll(".zoom-btn[data-zoom]").on("click", (event) => {
      const type = event.currentTarget.dataset.zoom;
      if (type === "in") setZoom(zoomFactor + zoomStep);
      else if (type === "out") setZoom(zoomFactor - zoomStep);
    });

    // Reset button
    d3.select(".zoom-reset").on("click", () => {
      rotation = initialRotation.slice();
      projection.rotate(rotation);
      zoomFactor = 1;
      resizeGlobe();
      
      // Also reset spinning state to active
      isSpinning = true;
      pauseToggleBtn.html("&#x25A0;").attr("title", languageData[currentLang].stopTitle);
    });
    
    // Pause/Start Spinning Button Logic (Toggles between Stop &#x25A0; and Play &#x25B6;)
    pauseToggleBtn.on("click", (event) => {
        isSpinning = !isSpinning;
        const button = d3.select(event.currentTarget);
        if (isSpinning) {
            button.html("&#x25A0;").attr("title", languageData[currentLang].stopTitle); // Stop symbol (square)
        } else {
            button.html("&#x25B6;").attr("title", languageData[currentLang].startTitle); // Play symbol (triangle)
        }
    });


    // Mouse wheel zoom (Desktop only)
    svg.on("wheel", (event) => {
      event.preventDefault();
      const direction = event.deltaY > 0 ? -1 : 1;
      setZoom(zoomFactor + direction * zoomStep);
    });

    // Tooltip helpers (NOW USES currentLang)
    function buildTooltipHTML(countryName) {
      const data = languageData[currentLang];
      const metrics = data.metrics;

      const { key, inList } = resolveCountryKey(countryName);
      const metricIds = inList ? (countryMetrics[key] || []) : [];

      let html = `<div class="tooltip-country">${countryName}</div>`;

      if (!inList) {
        html += `
          <div class="tooltip-metric">
            <div class="tooltip-metric-text">
              ${data.tooltipNoData}
            </div>
          </div>`;
        return html;
      }

      if (!metricIds.length) {
        html += `
          <div class="tooltip-metric">
            <div class="tooltip-metric-text">
              ${data.tooltipNoMetrics}
            </div>
          </div>`;
        return html;
      }

      html += metricIds
        .map((id) => {
          const m = metrics[id];
          if (!m) return "";
          return `
            <div class="tooltip-metric" style="border-left-color: ${m.color};">
              <div class="tooltip-metric-title" style="color: ${m.color};">
                ${m.title}
              </div>
              <div class="tooltip-metric-text">${m.description}</div>
            </div>`;
        })
        .join("");

      return html;
    }

    function moveTooltip(event) {
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      const isMobile = viewportWidth <= 700; 
    
      const tooltipNode = tooltip.node();
      const currentDisplay = tooltip.style('display');

      tooltip.style('display', 'block'); 
      const tooltipWidth = tooltipNode.offsetWidth;
      const tooltipHeight = tooltipNode.offsetHeight;
      tooltip.style('display', currentDisplay); 
    
      let finalX, finalY;
    
      if (isMobile) {
        // Centered position on mobile
        finalX = (viewportWidth / 2) - (tooltipWidth / 2);
        finalY = (viewportHeight / 2) - (tooltipHeight / 2) - 30; 
        
        finalX = Math.max(10, Math.min(finalX, viewportWidth - tooltipWidth - 10));
        finalY = Math.max(10, finalY);
    
      } else {
        // Offset position on desktop
        const x = event.clientX || (event.touches ? event.touches[0].clientX : d3.pointer(event)[0]);
        const y = event.clientY || (event.touches ? event.touches[0].clientY : d3.pointer(event)[1]);
    
        finalX = x + 18; 
        finalY = y + 18; 
    
        // Keep tooltip within viewport bounds
        if (finalX + tooltipWidth > viewportWidth - 10) {
          finalX = x - tooltipWidth - 18; 
        }
        
        if (finalY + tooltipHeight > viewportHeight - 10) {
          finalY = y - tooltipHeight - 18; 
        }
    
        if (finalX < 10) {
          finalX = 10;
        }
        
        if (finalY < 10) {
          finalY = 10;
        }
      }
    
      tooltip
        .style("left", finalX + "px")
        .style("top", finalY + "px");
    }

    // Load data
    d3.json("https://unpkg.com/world-atlas@2.0.2/countries-110m.json")
      .then(worldData => {
        const countries = topojson.feature(worldData, worldData.objects.countries).features;
        worldFeature = { type: "FeatureCollection", features: countries };

        landGroup.append("path")
          .datum(graticule())
          .attr("class", "graticule")
          .attr("d", path);

        landGroup.selectAll("path.country")
          .data(countries)
          .enter()
          .append("path")
          .attr("class", "country")
          .on("mouseover", (event, d) => {
            if (isDragging || pinchStartDistance !== null) return; 
            isHovering = true; // <-- Pause spinning on hover
            tooltip.style("display", "block").style("opacity", 1);
            
            const countryName =
              d.properties.name ||
              d.properties.admin ||
              "Unknown country";

            tooltip
              .html(buildTooltipHTML(countryName));

            moveTooltip(event);
          })
          .on("mousemove", (event) => {
            if (isDragging || pinchStartDistance !== null) return;
            moveTooltip(event);
          })
          .on("mouseout", () => {
            isHovering = false; // <-- Resume spinning on mouse out
            if (!isDragging && pinchStartDistance === null) { 
              tooltip.style("opacity", 0).style("display", "none");
            }
          })
          .on("touchstart", function(event, d) {
            if (event.touches.length > 1 || isDragging || isClicking || pinchStartDistance !== null) return;
            
            isClicking = true;
            event.preventDefault(); 
            isHovering = true; // <-- Pause spinning on touch/click

            const countryName = d.properties.name || d.properties.admin || "Unknown country";
            
            const currentCountry = tooltip.attr("data-country");
            if (currentCountry === countryName && tooltip.style("opacity") === "1") {
                tooltip.style("opacity", 0).style("display", "none");
                tooltip.attr("data-country", "");
                isHovering = false; // Resume spinning on second tap to close
                isClicking = false;
                return;
            }

            tooltip.attr("data-country", countryName);
            tooltip.style("display", "block").style("opacity", 1).html(buildTooltipHTML(countryName));
            
            moveTooltip(event);

            setTimeout(() => {
                isClicking = false;
            }, 300); 
          });

        resizeGlobe();
      })
      .catch(err => console.error("Error loading world data:", err));

    window.addEventListener("resize", resizeGlobe);

    // Initialize the page in English on load
    updateLanguage('en');
  </script>

  <script>
    (function () {
        const diag = document.getElementById("globe-diagnostics");

        function show(msg) {
            diag.style.display = "block";
            diag.innerHTML = "<b>Globe Diagnostics:</b><br>" + msg;
            console.warn("Globe Diagnostics:", msg);
        }

        function webglSupported() {
            try {
                const c = document.createElement("canvas");
                return !!window.WebGLRenderingContext &&
                       (c.getContext("webgl") || c.getContext("experimental-webgl"));
            } catch (e) {
                return false;
            }
        }

        function webgl2Supported() {
            try {
                const c = document.createElement("canvas");
                return !!c.getContext("webgl2");
            } catch (e) {
                return false;
            }
        }

        // 1. Check WebGL support
        if (!webglSupported()) {
            show("‚ùå Your browser does not support WebGL. The 3D globe cannot be displayed.<br>" +
                 "‚û° Try updating your browser or enabling hardware acceleration.");
            return;
        }

        // 2. Warn if WebGL2 is missing (Some libs rely on it)
        if (!webgl2Supported()) {
            show("‚ö† WebGL works, but WebGL2 is not supported.<br>" +
                 "The globe may appear but could be slow or incomplete.");
        }

        // 3. Detect disabled hardware acceleration
        const gl = document.createElement("canvas").getContext("webgl");
        const info = gl && gl.getExtension("WEBGL_debug_renderer_info");

        if (info) {
            const renderer = gl.getParameter(info.UNMASKED_RENDERER_WEBGL);
            if (renderer.toLowerCase().includes("swiftshader") ||
                renderer.toLowerCase().includes("software")) {
                show("‚ö† WebGL is running in SOFTWARE mode (not hardware).<br>" +
                     "The 3D globe may fail to render or appear very slow.<br>" +
                     "‚û° Enable GPU acceleration in your browser settings.");
            }
        }

        // 4. Catch global JS errors so missing assets get reported
        window.addEventListener("error", function (e) {
            // Check if the error is related to D3, TopoJSON, or the map logic
            const related = e.message.includes("d3") || e.message.includes("topojson") || e.filename.includes("script");
            if (related) {
                show("‚ùå A script error occurred while loading the 3D globe:<br>" +
                     "<span style='color:#f88'>" + e.message + "</span><br>" +
                     "‚û° Check your console for missing files, wrong paths, or CORS issues.");
            }
        });

        // 5. Detect WebGL context loss
        window.addEventListener("webglcontextlost", function () {
            show("‚ùå The WebGL context was lost.<br>" +
                 "This usually means the browser or GPU blocked the 3D view.");
        });

    })();
  </script>
</body>
</html>
